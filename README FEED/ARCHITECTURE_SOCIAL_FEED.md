# ğŸ“ Architecture du SystÃ¨me de Feed Social

## Vue d'ensemble du flux de donnÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT (Frontend)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Create Post â”‚  â”‚  View Feed   â”‚  â”‚  Like/Save   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FASTAPI ROUTES                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  /api/feed/posts (POST)                                          â”‚   â”‚
â”‚  â”‚  /api/feed (GET) ?limit=20&last_seen_score=145.3                 â”‚   â”‚
â”‚  â”‚  /api/feed/tag/{tag_name} (GET)                                  â”‚   â”‚
â”‚  â”‚  /api/feed/posts/{id}/like (POST)                                â”‚   â”‚
â”‚  â”‚  /api/feed/posts/{id}/save (POST)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   SUPABASE CLIENT         â”‚   â”‚  CELERY WORKER        â”‚
         â”‚   (Database Access)       â”‚   â”‚  (Async Processing)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                            â”‚
                      â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          POSTGRESQL DATABASE                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  posts   â”‚  â”‚   tags   â”‚  â”‚post_tags â”‚  â”‚post_likesâ”‚               â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚               â”‚
â”‚  â”‚ - id     â”‚  â”‚ - id     â”‚  â”‚ - post_idâ”‚  â”‚ - post_idâ”‚               â”‚
â”‚  â”‚ - contentâ”‚  â”‚ - name   â”‚  â”‚ - tag_id â”‚  â”‚ - user_idâ”‚               â”‚
â”‚  â”‚ - virali â”‚  â”‚ - trend_ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”‚   ty_sco â”‚  â”‚   score  â”‚                                            â”‚
â”‚  â”‚   re     â”‚  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ - createdâ”‚  â”‚ - orga   â”‚  â”‚post_savesâ”‚  â”‚post_comm â”‚               â”‚
â”‚  â”‚   _at    â”‚  â”‚   nizationâ”‚ â”‚          â”‚  â”‚  ents    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - post_idâ”‚  â”‚ - contentâ”‚               â”‚
â”‚                               â”‚ - user_idâ”‚  â”‚ - post_idâ”‚               â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“Š STORED FUNCTIONS                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  get_social_feed(p_user_org_id, p_limit, p_last_seen_score)     â”‚   â”‚
â”‚  â”‚  get_feed_by_tag(p_user_org_id, p_tag_name, p_limit, ...)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flow : CrÃ©ation d'un Post avec Cold Start

```
 USER                    API                  DB              CELERY
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  POST /api/feed/     â”‚                    â”‚                 â”‚
  â”‚  posts              â”‚                    â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                 â”‚
  â”‚                      â”‚  INSERT INTO postsâ”‚                 â”‚
  â”‚                      â”‚  (virality_score= â”‚                 â”‚
  â”‚                      â”‚   50.0)           â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚  Associate tags    â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  â—„â”€â”€â”€{post_data}â”€â”€â”€â”€â”¤                    â”‚                 â”‚
  â”‚  (score: 50)         â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚  Trigger task      â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚  calculate_     â”‚
  â”‚                      â”‚                    â”‚  virality_      â”‚
  â”‚                      â”‚                    â”‚  score_task()   â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                    â”‚  â”‚ age = 0.1h   â”‚
  â”‚                      â”‚                    â”‚  â”‚ (< 2h!)      â”‚
  â”‚                      â”‚                    â”‚  â”‚              â”‚
  â”‚                      â”‚                    â”‚  â”‚ BOOST = 50 âœ“ â”‚
  â”‚                      â”‚                    â”‚  â”‚              â”‚
  â”‚                      â”‚                    â”‚  â”‚ engagement=0 â”‚
  â”‚                      â”‚                    â”‚  â”‚              â”‚
  â”‚                      â”‚                    â”‚  â”‚ score =      â”‚
  â”‚                      â”‚                    â”‚  â”‚ (0+50) Ã— 1.0 â”‚
  â”‚                      â”‚                    â”‚  â”‚ = 50         â”‚
  â”‚                      â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚  UPDATE posts      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚  SET virality_     â”‚                 â”‚
  â”‚                      â”‚  score = 50        â”‚                 â”‚
  â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  GET /api/feed       â”‚                    â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                 â”‚
  â”‚                      â”‚  get_social_feed() â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  â—„â”€â”€â”€[New Post]â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚  (at TOP! score=50)  â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚

  â±ï¸  2 HOURS LATER...

  USER                    API                  DB              CELERY
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  POST /api/feed/     â”‚                    â”‚                 â”‚
  â”‚  posts/{id}/like     â”‚                    â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                 â”‚
  â”‚                      â”‚  INSERT post_likes â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚ (trigger auto-     â”‚                 â”‚
  â”‚                      â”‚  update likes_countâ”‚                 â”‚
  â”‚                      â”‚  via DB trigger)   â”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚  Trigger recalc    â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚  calculate_     â”‚
  â”‚                      â”‚                    â”‚  virality_      â”‚
  â”‚                      â”‚                    â”‚  score_task()   â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                    â”‚  â”‚ age = 2.5h   â”‚
  â”‚                      â”‚                    â”‚  â”‚ (> 2h)       â”‚
  â”‚                      â”‚                    â”‚  â”‚              â”‚
  â”‚                      â”‚                    â”‚  â”‚ BOOST = 0 âŒ â”‚
  â”‚                      â”‚                    â”‚  â”‚              â”‚
  â”‚                      â”‚                    â”‚  â”‚ engagement=1 â”‚
  â”‚                      â”‚                    â”‚  â”‚              â”‚
  â”‚                      â”‚                    â”‚  â”‚ score =      â”‚
  â”‚                      â”‚                    â”‚  â”‚ (1+0) Ã— 1.0  â”‚
  â”‚                      â”‚                    â”‚  â”‚ = 1          â”‚
  â”‚                      â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚  UPDATE posts      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚  SET virality_     â”‚                 â”‚
  â”‚                      â”‚  score = 1         â”‚                 â”‚
  â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  GET /api/feed       â”‚                    â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                 â”‚
  â”‚                      â”‚  get_social_feed() â”‚                 â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
  â”‚  â—„â”€â”€â”€[Post moved]â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚  (DOWN! score=1)     â”‚                    â”‚                 â”‚
  â”‚                      â”‚                    â”‚                 â”‚
```

---

## ğŸ·ï¸ Flow : Filtrage par Tag

```
 USER                    API                         DATABASE
  â”‚                      â”‚                              â”‚
  â”‚  GET /api/feed/      â”‚                              â”‚
  â”‚  tag/innovation      â”‚                              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
  â”‚                      â”‚                              â”‚
  â”‚                      â”‚  get_feed_by_tag(            â”‚
  â”‚                      â”‚    p_user_org_id: 'uuid1',   â”‚
  â”‚                      â”‚    p_tag_name: 'innovation', â”‚
  â”‚                      â”‚    p_limit: 20               â”‚
  â”‚                      â”‚  )                           â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                      â”‚                              â”‚
  â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚  â”‚ SELECT posts.*            â”‚
  â”‚                      â”‚  â”‚ FROM posts                â”‚
  â”‚                      â”‚  â”‚ JOIN post_tags ON ...     â”‚
  â”‚                      â”‚  â”‚ JOIN tags ON ...          â”‚
  â”‚                      â”‚  â”‚ WHERE tags.name =         â”‚
  â”‚                      â”‚  â”‚   'innovation'            â”‚
  â”‚                      â”‚  â”‚ AND (                     â”‚
  â”‚                      â”‚  â”‚   posts.org_id = 'uuid1'  â”‚
  â”‚                      â”‚  â”‚   OR                      â”‚
  â”‚                      â”‚  â”‚   virality_level IN       â”‚
  â”‚                      â”‚  â”‚   ('viral','national',    â”‚
  â”‚                      â”‚  â”‚    'global')              â”‚
  â”‚                      â”‚  â”‚ )                         â”‚
  â”‚                      â”‚  â”‚ ORDER BY virality_score   â”‚
  â”‚                      â”‚  â”‚ DESC                      â”‚
  â”‚                      â”‚  â”‚ LIMIT 20                  â”‚
  â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                              â”‚
  â”‚  â—„â”€â”€â”€[Posts with]â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  'innovation' tag    â”‚                              â”‚
  â”‚  (Local + Viral)     â”‚                              â”‚
  â”‚                      â”‚                              â”‚
```

---

## ğŸ“Š Algorithme de Score (DÃ©tails)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            VIRALITY SCORE CALCULATION                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUTS:
  â”œâ”€ likes_count      (weight: 1)
  â”œâ”€ comments_count   (weight: 3)
  â”œâ”€ shares_count     (weight: 5)
  â”œâ”€ saves_count      (weight: 10)
  â””â”€ age_hours        (from created_at)

STEP 1: Calculate Engagement Score
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ engagement_score =                       â”‚
â”‚   (likes Ã— 1) +                          â”‚
â”‚   (comments Ã— 3) +                       â”‚
â”‚   (shares Ã— 5) +                         â”‚
â”‚   (saves Ã— 10)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 2: Apply Cold Start Boost
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF age_hours < 2:                        â”‚
â”‚   boost_newness = 50  ğŸš€                 â”‚
â”‚ ELSE:                                    â”‚
â”‚   boost_newness = 0                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 3: Calculate Score with Boost
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ score_with_boost =                       â”‚
â”‚   engagement_score + boost_newness       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 4: Determine Virality Level & Multiplier
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF score >= 10000:                       â”‚
â”‚   level = "global",   multiplier = 5.0   â”‚
â”‚ ELIF score >= 2000:                      â”‚
â”‚   level = "national", multiplier = 3.0   â”‚
â”‚ ELIF score >= 500:                       â”‚
â”‚   level = "viral",    multiplier = 2.0   â”‚
â”‚ ELIF score >= 100:                       â”‚
â”‚   level = "trending", multiplier = 1.5   â”‚
â”‚ ELSE:                                    â”‚
â”‚   level = "local",    multiplier = 1.0   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 5: Final Score
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ virality_score =                         â”‚
â”‚   score_with_boost Ã— multiplier          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXEMPLE:
  Post neuf (30 min), 0 engagement
  â”œâ”€ engagement_score = 0
  â”œâ”€ boost_newness = 50 (< 2h)
  â”œâ”€ score_with_boost = 0 + 50 = 50
  â”œâ”€ level = "local" (< 100)
  â”œâ”€ multiplier = 1.0
  â””â”€ virality_score = 50 Ã— 1.0 = 50 âœ“

  Same post, 3h later, 1 like
  â”œâ”€ engagement_score = 1 Ã— 1 = 1
  â”œâ”€ boost_newness = 0 (> 2h)
  â”œâ”€ score_with_boost = 1 + 0 = 1
  â”œâ”€ level = "local"
  â”œâ”€ multiplier = 1.0
  â””â”€ virality_score = 1 Ã— 1.0 = 1 âŒ

  Viral post: 200 likes, 50 comments, 20 saves
  â”œâ”€ engagement_score = (200Ã—1) + (50Ã—3) + (20Ã—10)
  â”‚                   = 200 + 150 + 200 = 550
  â”œâ”€ boost_newness = 0 (old post)
  â”œâ”€ score_with_boost = 550
  â”œâ”€ level = "viral" (>= 500)
  â”œâ”€ multiplier = 2.0
  â””â”€ virality_score = 550 Ã— 2.0 = 1100 ğŸ”¥
```

---

## ğŸ”„ Pagination par Curseur (ExpliquÃ©)

```
PROBLÃˆME avec OFFSET:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SELECT * FROM posts                                     â”‚
â”‚  ORDER BY virality_score DESC                            â”‚
â”‚  LIMIT 20 OFFSET 100  â† DB doit scanner 120 rows!       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Performance: O(n + offset)  ğŸ˜¢

SOLUTION avec CURSOR:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Page 1:                                                 â”‚
â”‚  SELECT * FROM posts                                     â”‚
â”‚  WHERE TRUE                                              â”‚
â”‚  ORDER BY virality_score DESC                            â”‚
â”‚  LIMIT 20                                                â”‚
â”‚                                                          â”‚
â”‚  â†’ Returns posts with scores [500, 499, ..., 145.3]     â”‚
â”‚  â†’ next_cursor = 145.3 (last post's score)              â”‚
â”‚                                                          â”‚
â”‚  Page 2:                                                 â”‚
â”‚  SELECT * FROM posts                                     â”‚
â”‚  WHERE virality_score < 145.3  â† Direct index lookup!   â”‚
â”‚  ORDER BY virality_score DESC                            â”‚
â”‚  LIMIT 20                                                â”‚
â”‚                                                          â”‚
â”‚  â†’ Returns posts with scores [145.2, 145.1, ..., 89.5]  â”‚
â”‚  â†’ next_cursor = 89.5                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Performance: O(log n + limit)  ğŸš€

INDEX USED:
  idx_posts_feed_query ON (organization_id, virality_score DESC)
  â†’ Index scan, pas de full table scan!
```

---

## ğŸ¯ Logique "Local OR Viral"

```
USER dans Organization A

FEED QUERY:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHERE (                                                 â”‚
â”‚    posts.organization_id = 'org_a'  â† Posts locaux      â”‚
â”‚    OR                                                    â”‚
â”‚    posts.virality_level IN (        â† Posts viraux      â”‚
â”‚      'viral',                        (autres orgs)      â”‚
â”‚      'national',                                         â”‚
â”‚      'global'                                            â”‚
â”‚    )                                                     â”‚
â”‚  )                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ‰SULTAT:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Post 1: Org A, score 150, level "trending"â”‚  âœ“ Local
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Post 2: Org B, score 800, level "viral"   â”‚  âœ“ Viral
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Post 3: Org A, score 50,  level "local"   â”‚  âœ“ Local
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Post 4: Org C, score 30,  level "local"   â”‚  âŒ Ni local, ni viral
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DANS LE FEED:
  1. Post 2 (Org B, viral)    - score 800
  2. Post 1 (Org A, trending) - score 150
  3. Post 3 (Org A, local)    - score 50
```

---

## ğŸ—ï¸ Tables & Relations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    users     â”‚       â”‚    posts     â”‚       â”‚     tags     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)      â”‚â—„â”€â”€â”€â”€â”€â”¤â”‚ id (PK)      â”‚       â”‚ id (PK)      â”‚
â”‚ email        â”‚      1:N              N:M     â”‚ name         â”‚
â”‚ org_id (FK)  â”‚       â”‚ user_id (FK) â”‚       â”‚ trend_score  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ org_id (FK)  â”‚       â”‚ org_id (FK)  â”‚
                       â”‚ content      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ virality_    â”‚             â–²
                       â”‚  score       â”‚             â”‚
                       â”‚ virality_    â”‚             â”‚
                       â”‚  level       â”‚             â”‚
                       â”‚ likes_count  â”‚             â”‚
                       â”‚ saves_count  â”‚             â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                             â”‚                      â”‚
                             â”‚                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚        â”‚          â”‚
                    â”‚        â”‚          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚post_    â”‚  â”‚post_     â”‚  â”‚post_tags   â”‚
            â”‚ likes   â”‚  â”‚ saves    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚post_id (FK)â”‚
            â”‚post_id  â”‚  â”‚post_id   â”‚  â”‚tag_id (FK) â”‚
            â”‚user_id  â”‚  â”‚user_id   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Cette architecture assure :
âœ… Performance optimale (indexes, stored functions, cursor pagination)
âœ… ScalabilitÃ© (multi-tenant, async workers)
âœ… FiabilitÃ© (triggers DB, transactions)
âœ… ExtensibilitÃ© (facile d'ajouter de nouvelles features)
